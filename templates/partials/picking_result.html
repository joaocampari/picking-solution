<div class="bg-white shadow rounded-lg p-6">
    {% if route %}
    <div class="mb-4 flex justify-between items-center">
        <h3 class="text-lg font-medium text-gray-900">Plano de Picking</h3>
        <div class="space-x-2">
            <a
                href="/picking/plan.csv"
                class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700"
            >
                Exportar CSV
            </a>
            <button
                onclick="startPicking()"
                class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700"
            >
                Iniciar Coleta
            </button>
            <button
                onclick="cancelPlan()"
                class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700"
                title="Cancelar plano e voltar devices para IN_STOCK"
            >
                Cancelar Plano
            </button>
        </div>
    </div>

    <div class="mb-4 p-4 bg-gray-50 rounded-lg">
        <p class="text-sm text-gray-700">
            <strong>Distância total:</strong> {{ "%.2f"|format(total_distance) }}
        </p>
        {% if start_position %}
        <p class="text-sm text-gray-700">
            <strong>Posição inicial:</strong> {{ start_position.human_code }}
        </p>
        {% endif %}
    </div>

    <div class="mb-4">
        <label for="bip-input" class="block text-sm font-medium text-gray-700 mb-2">
            Bip aqui (campo focado para digitar/escanear Device ID):
        </label>
        <input
            type="text"
            id="bip-input"
            name="device_id"
            class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border border-gray-300 rounded-md p-2"
            placeholder="Digite ou escaneie o Device ID"
            autofocus
            onkeypress="if(event.key === 'Enter') { handleBip(this.value); }"
        />
    </div>

    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ordem</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Device ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Slot (Código Humano)</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Linha</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Coluna</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Distância Acumulada</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200" id="picking-items">
                {% for item in route %}
                <tr id="row-{{ item.device_id }}" data-status="PENDING" class="{% if item.picked %}bg-green-50{% endif %}">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ loop.index }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ item.device_id }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ item.human_code }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ item.row }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ item.col }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ "%.2f"|format(item.cumulative_distance) }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="status-badge px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Pendente</span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="p-4 bg-yellow-50 rounded-lg">
        <p class="text-sm text-yellow-900">
            {% if error %}
            <strong>Erro:</strong> {{ error }}
            {% else %}
            Nenhum device encontrado em estoque para coleta.
            {% endif %}
        </p>
    </div>
    {% endif %}
</div>

<script>
function setBadge(row, text, cls) {
    const badge = row.querySelector('.status-badge');
    if (badge) {
        badge.textContent = text;
        badge.className = 'status-badge px-2 inline-flex text-xs leading-5 font-semibold rounded-full ' + cls;
    }
}

function handleBip(deviceId) {
    if (!deviceId || !deviceId.trim()) return;
    deviceId = deviceId.trim();
    const row = document.getElementById('row-' + deviceId);
    if (!row) {
        if (confirm('Device não está no plano. Deseja cancelar o plano e resetar os statuses?')) {
            cancelPlan();
        }
        return;
    }

    const status = row.getAttribute('data-status') || 'PENDING';

    if (status === 'PENDING') {
        // Primeiro bip: marcar como IN_TRANSIT
        fetch('/picking/mark-in-transit?device_id=' + encodeURIComponent(deviceId), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
        }).then(r => r.json()).then(data => {
            if (data.success) {
                row.setAttribute('data-status', 'IN_TRANSIT');
                setBadge(row, 'EM TRÂNSITO', 'bg-blue-100 text-blue-800');
            } else {
                alert('Erro: ' + (data.error || 'Falha ao marcar IN_TRANSIT'));
            }
            document.getElementById('bip-input').value = '';
            document.getElementById('bip-input').focus();
        }).catch(err => alert('Erro: ' + err));
    } else if (status === 'IN_TRANSIT') {
        // Segundo bip: marcar como PICKED (CHECK_OUT)
        fetch('/picking/mark-picked?device_id=' + encodeURIComponent(deviceId), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
        }).then(r => r.json()).then(data => {
            if (data.success) {
                row.setAttribute('data-status', 'PICKED');
                row.classList.add('bg-green-50');
                setBadge(row, 'PICKED', 'bg-green-100 text-green-800');
            } else {
                alert('Erro: ' + (data.error || 'Falha ao marcar PICKED'));
            }
            document.getElementById('bip-input').value = '';
            document.getElementById('bip-input').focus();
        }).catch(err => alert('Erro: ' + err));
    } else {
        // já picked
        document.getElementById('bip-input').value = '';
        document.getElementById('bip-input').focus();
    }
}

function startPicking() {
    document.getElementById('bip-input').focus();
    alert('Modo de coleta iniciado! Primeiro bip marca EM TRÂNSITO; segundo bip marca PICKED.');
}

function cancelPlan() {
    fetch('/picking/reset', { method: 'POST', headers: { 'Content-Type': 'application/json' }})
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert('Plano cancelado e devices resetados para IN_STOCK.');
                // limpar tabela visualmente
                const tbody = document.getElementById('picking-items');
                if (tbody) tbody.innerHTML = '';
            } else {
                alert('Erro ao cancelar plano: ' + (data.error || ''));
            }
        })
        .catch(err => alert('Erro: ' + err));
}
</script>

